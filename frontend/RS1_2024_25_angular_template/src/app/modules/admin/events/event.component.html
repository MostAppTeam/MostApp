<div id="events-container">
  <!-- User info -->
  <div class="user-info">
    <p><strong>Logged in as:</strong> {{ loggedInUser?.username || 'Guest' }}</p>
    <p><strong>Role:</strong> {{ loggedInUser?.isAdmin ? 'Admin' : loggedInUser?.isManager ? 'Manager' : 'User' }}</p>
  </div>

  <!-- Sort -->
  <div id="sort-container">
    <h3>Sort Events</h3>
    <select [(ngModel)]="sortOption" (change)="applySorting()">
      <option value="nameAsc">Name (A–Z)</option>
      <option value="nameDesc">Name (Z–A)</option>
      <option value="dateAsc">Date (Newest First)</option>
      <option value="dateDesc">Date (Oldest First)</option>
    </select>
  </div>

  <h3>Existing Events</h3>
  <div *ngIf="filteredEvents.length > 0; else noEventsMessage" class="event-cards">
    <div class="event-card" *ngFor="let event of filteredEvents">
      <h4>{{ event.name }}</h4>

      <!-- Event image (click to zoom) -->
      <div
        *ngIf="event.imageUrl"
        class="img-wrap"
        (click)="openViewer(getEventImageUrl(event))"
      >
        <img
          [src]="getEventImageUrl(event)"
          alt="{{ event.name }}"
          width="250"
          class="zoomable"
        />
        <span class="zoom-hint">Click to zoom</span>
      </div>

      <p>{{ event.description }}</p>
      <p><strong>Date:</strong> {{ event.date }}</p>
      <p><strong>Location:</strong> {{ event.location }}</p>

      <!-- Admin/Manager actions -->
      <div class="event-actions" *ngIf="isAdminOrManager">
        <button (click)="editEvent(event)">Edit</button>
        <button (click)="deleteEvent(event.id)">Delete</button>
      </div>
    </div>
  </div>

  <ng-template #noEventsMessage>
    <p>No events available.</p>
  </ng-template>

  <!-- Download PDF -->
  <div class="pdf-download-container">
    <button type="button" class="btn-download" (click)="downloadEventsPDF()">
      Download Events Report
    </button>
  </div>

  <!-- Add New Event (Admin/Manager) -->
  <div *ngIf="isAdminOrManager">
    <form (ngSubmit)="addEvent()" id="add-event-form" #eventForm="ngForm">
      <h3>Add Event</h3>

      <input [(ngModel)]="newEvent.name" placeholder="Event Name" name="name" required />
      <input [(ngModel)]="newEvent.date" placeholder="Date" name="date" required type="date" />
      <input [(ngModel)]="newEvent.location" placeholder="Location" name="location" required />
      <textarea [(ngModel)]="newEvent.description" placeholder="Description" name="description" required></textarea>

      <!-- Image URL gets filled after upload -->
      <input [(ngModel)]="newEvent.imageUrl" placeholder="Image URL" name="imageUrl" readonly />

      <!-- Upload file for new event -->
      <input type="file" (change)="onNewEventFileSelected($event)" />

      <button type="submit">Add Event</button>
    </form>
  </div>

  <!-- Filter -->
  <div id="filter-container">
    <h3>Filter Events</h3>
    <input [(ngModel)]="filterParams.name" placeholder="Event Name" name="filterName" />
    <input [(ngModel)]="filterParams.date" placeholder="Date" name="filterDate" type="date" />
    <input [(ngModel)]="filterParams.location" placeholder="Location" name="filterLocation" />
    <input [(ngModel)]="filterParams.description" placeholder="Description" name="filterDescription" />
    <button (click)="applyFilter()">Apply Filter</button>
  </div>

  <!-- Feedback -->
  <div *ngIf="feedbackMessage" class="feedback-message">
    <p>{{ feedbackMessage }}</p>
  </div>

  <!-- Map -->
  <div id="map" style="height: 400px;"></div>

  <!-- LIGHTBOX / IMAGE VIEWER -->
  <div
    *ngIf="viewerOpen"
    class="lightbox"
    (click)="closeViewer()"
    (window:keydown.escape)="closeViewer()"
  >
    <div
      class="lightbox-content"
      (click)="$event.stopPropagation()"
      (wheel)="onWheelZoom($event)"
      (mousedown)="onMouseDown($event)"
      (mousemove)="onMouseMove($event)"
      (mouseup)="onMouseUp()"
      (mouseleave)="onMouseUp()"
      (dblclick)="resetView()"
      tabindex="0"
    >
      <img
        [src]="viewerImageUrl"
        alt="Event image"
        [ngStyle]="getZoomStyle()"
        draggable="false"
        class="zoom-target"
      />
    </div>


    <div class="lightbox-controls" (click)="$event.stopPropagation()">
      <div class="zoom-controls">
        <button (click)="setZoomLevel(zoomScale + 0.2)" class="zoom-btn">+</button>
        <button (click)="setZoomLevel(zoomScale - 0.2)" class="zoom-btn">−</button>
      </div>
      <button type="button" class="close-btn" (click)="closeViewer()">✕</button>
    </div>

    <div class="lightbox-tip">
      Use scroll to zoom, drag to move, and double-click to reset.
    </div>
  </div>
</div>
